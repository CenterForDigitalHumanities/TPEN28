<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <title>T-PEN Transcription</title>
        <link type="text/css" href="css/custom-theme/jQuery.css" rel="Stylesheet" />
        <link type="text/css" href="css/transcribeSkin.css" rel="Stylesheet" />
    <style>
        p{
            padding: 0px 10px;
        }
        #topTrim{
            position: relative;
            display: block;
            width: 100%;
        }
        #topTrim span{
            display: inline-block;
            border-right: 2px solid black;
        }
        .magnifyHelp{
            position: fixed;
            top:35px;
            left: 0;
            right:0;
            margin: 0 auto;
            border: 2px outset #002a5c;
            background-color: #BFBFBF;
            height: 134px;
            width: 200px;
            font-size: 9pt;
            padding: 4px 6px;
            color: #002a5c;
            height: 140px;
            z-index: 3;
            display: none;
        }

        .magifyHelp button{
            width: 35px;
        }

        .parsingHdr{
            margin-left: 20px;
        }




    </style>
    </head>
    <body>
        <div class="pageTurnCover">
            <div class="turnMsg">Please wait while we load the page...</div>
            <div class="turnLoader"><img src="images/loading2.gif" /></div>
        </div>
        <div class="magnifyHelp">
            <div id='magnifyHlpLabel'>Inspect Help</div>
            <button style='margin-bottom: 3px;' class='nohover'>esc</button><span>   to quit</span><br>
            <button style='margin-bottom: 3px;' class='nohover'>+</button><span>   or mouse wheel to zoom in</span><br>
            <button class='nohover'>-</button><span>   or mouse wheel to zoom out</span>
        </div>
        <div class="topTrim navigation">
            <span class="trimSection"><span id="trimTitle"></span>
            </span>
            <span class="trimSection">
                <span id="trimPage"></span>
                <a class="exitPage" id="prevCanvas" onclick="previousFolio();" title="Previous Page">
                    <i class="fa fa-caret-left fa-2x"></i>
                </a>
                <select id="pageJump">
                    <option id="activePage" folioNum="0">Jump to Page</option>
                </select>
                <a class="exitPage" id="nextCanvas" title="Next Page" onclick="nextFolio();">
                    <i class="fa fa-caret-right fa-2x"></i>
                </a>
            </span>
            <span class="trimSection">Transcribing as <span id="trimCurrentUser"></span></span>
            <div style="position:absolute;right:0;top:0;z-index: 1;">
                <span class="trimSection">
                    <a class="exitPage wBtn ui-state-default ui-button" title="T-PEN Home" href="index.jsp"><span class="fa fa-home"></span>T-PEN Home</a>
                    <a class="exitPage wBtn ui-state-default ui-button" title="My Projects" href="project.jsp">My&nbsp;Projects</a>
                </span>
                <span class="trimSection">
                    <a id="helpContact" href="admin.jsp#aboutTab" target="_blank" class="wBtn ui-state-default ui-button">Contact <span class="fa fa-comment"></span></a>
                </span>
                <span class="trimSection">
                    <a id="helpMe" onclick="Help.revealHelp();" class="ui-state-default ui-button">Help<i class="fa fa-question" style="margin-left:8px" aria-hidden="true"></i></a>
                </span>
            </div>
        </div>

        <div class="instructions">
            <!-- TODO: Arc we logged in to see this? -->
            <p>
                The area below accepts a local project ID number, a project or IIIF manifest url, or a valid T-PEN or IIIF manifest JSON object as valid input.
            </p>
            <p>
                Once you have decided what to put into the area, click 'Load Transcription' to have the input created into the transcription interface.
            </p>
        </div>

        <div id="setTranscriptionObjectArea">
            <textarea id="transcriptionText" placeholder="Transcribe this line"></textarea>
        </div>

        <button id="loadBtn" class="hideme" onclick="loadTranscription();"> Load Transcription </button>
        <div id="transTemplateLoading">
            <p class="turnMsg">Please wait while we load the transcription interface.</p>
            <div class="turnLoader transLoader"><img src="images/loading2.gif" /></div>
        </div>
        <div id="transcriptionTemplate">
            <div id="templateResizeBar"></div>
            <div id="parsingCover"></div>
            <div id="transcriptionCanvas">
                <div id="noLineWarning">
                    <div id="noLineConfirmation">This canvas has no lines. You must be a leader for this project to create lines.
                    <span style="color: red;" onclick="$('#noLineWarning').hide()">dismiss this message</span>.</div>
                </div>
                <div id="imgTop">
                  <img class="transcriptionImage"/>
                  <div class="lineColIndicatorArea">
                  </div>
                </div>
                <div id="transWorkspace">
                    <div title="Slide Workspace" class="workspaceHandle slideHandleLeft"><i class="fa fa-bars"></i><i class="fa fa-arrows-v"></i></div><div title="Slide Workspace" class="workspaceHandle slideHandleRight"><i class="fa fa-arrows-v"></i><i class="fa fa-bars"></i></div>
                    <div class="flex-container flex-stretch">
                        <div class="flex-bookend"></div>
                        <div class="flex-stretch">
                            <div title="Previous Line" id="prevColLine"></div>
                        </div>
                        <div id="captions" class="flex-wide">
                            <div id="captionsText"></div>
                        </div>
                        <div class="flex-bookend">
                            <div id="saveReport" class="ui-corner-top"></div>
                        </div>
                    </div>
                    <div class="flex-container flex-stretch">
                        <div class="flex-bookend">
                            <button id="prevLine" title="Previous Line" onclick="previousTranscriptlet();">
                                <i class="fa fa-chevron-left fa-2x"></i><br>
                                Previous Line
                            </button>
                            <button id="prevPage" title="Previous Page" onclick="previousFolio();">
                                <i class="fa fa-backward fa-2x"></i><br>
                                Previous Page
                            </button>
                        </div>
                        <div class="flex-stretch">
                            <div title="Current Line" id="currentColLine"></div>
                            <button id='toggleNotes' role="button" onclick="$('.notes').fadeToggle('slow')" title='Toggle Notes'>
                                <i class="fa fa-comment"></i>
                            </button>
                        </div>
                        <div id="transcriptletArea" class="flex-wide">
                            <div class="xmlClosingTags"></div>

                        </div>

                        <div class="flex-bookend">
                            <button id="nextLine" title="Next Line" onclick="nextTranscriptlet();">
                                <i class="fa fa-chevron-right fa-2x"></i><br>
                                Next Line
                            </button>
                            <button id="nextPage" title="Next Page" onclick="nextFolio();">
                                <i class="fa fa-forward fa-2x"></i><br>
                                Next Page
                            </button>
                        </div>
                    </div>
                    <div class="flex-container flex-stretch buttons">
                        <select id="splitScreenTools" >
                            <option selected>Splitscreen Tools</option>
                        </select>
                        <button id="canvasControls" title="Page Tools" onclick="splitPage(event,'controls');">
                            <i class="fa fa-file-image-o"></i>
                            Page Tools</button>
                        <button id="magnify1" class="magnifyBtn" magnifyImg="trans" title="Inspect Transcription Image" >
                            <i class="fa fa-search-plus"></i>
                            Inspect</button> <!--Page event on the listener for this class in js.-->
                        <button id="toggleChars" title="Move Transcription Image" onclick="toggleSpecialChars(event);">
                            <i class="fa fa-keyboard-o"></i>
                            Characters</button>
                        <button id="toggleXML" title="Move Transcription Image" onclick="toggleXMLTags(event);">
                            <i class="fa fa-code"></i>
                            XML Tags</button>
                    </div>
                    <div id="specialCharsFloat" class="flex-container flex-stretch specialCharactered">
                        <a title="Edit Special Characters" class="pull-left lookLikeButtons editButtons exitPage" href="buttons.jsp">
                            <i class="fa fa-edit"></i>
                        </a>
                        <div class="closeBtn" onclick="$('#toggleChars').click();">
                            <i class="fa fa-close"></i>
                        </div>
                        <div id="charactersPopin" class="specialCharacters"  title="Special Characters" >
                        </div>
                    </div>
                    <div id="xmlTagFloat" class="flex-container flex-stretch xmlTagged">
                        <a title="Edit XML Tags" class="pull-left lookLikeButtons editXMLs exitPage" href="buttons.jsp">
                            <i class="fa fa-edit"></i>
                        </a>
                        <div class="closeBtn" onclick="$('#toggleXML').click();">
                            <i class="fa fa-close"></i>
                        </div>
                        <div id="xmlTagPopin" class="xmlTags" title="Custom XML Tags">
                        </div>
                    </div>

                </div>
                <div id="imgBottom">
                <img class="transcriptionImage" />
                <div class="lineColIndicatorArea"></div>
              </div><br>
            </div>
        </div>
         <div id="parsingSplit" class="split" >
             <div class="fullScreenTrans">⇥ Close Tool</div>
             <div class="toolLinks">
                <!-- tool buttons for parsing -->
                </div>

                <div id="parsingDiv" class="">
                    <div style="margin-top: 35px;">Any lines or columns that are created or edited are saved automatically.  This is also true for edits made in the full page transcription interface.</div>
                    <div id="parseOptions">
                        <h3 class="parsingHdr">Line Parsing</h3>
                        <div id="ctrlColumnsInst" class="actions">
                            <h4 id="ctrlColumns" title="Make adjustments at the column level" class="clear-left">Column Controls</h4>
                                <div class="parsingToolButtons">
                                    <span id="createColumn" class="tpenButton" title="Create new columns by clicking and dragging" show="createColumnInst">Adjust or Create Columns</span>
                                    <span id="destroyColumn" class="tpenButton" title="Remove an entire column and its data with a click" show="destroyColumnInst">Destroy Columns</span>
                                    <span id="clearColumns" class="tpenButton" title="Clear the page, removing all transcription information" show="clearColumnsInst">Clear Page</span>
                                </div>
                                <div class="activeParsingTool">
                                    <div class="startHide" id="createColumnInst">
                                        <dl>
                                            <dt>New Column:</dt>
                                            <dd>Click and drag to place</dd><br>
                                            <dt>Adjustments:</dt>
                                            <dd>Drag the edges of an existing column</dd>
                                        </dl>
                                    </div>
                                    <div class="startHide" id="destroyColumnInst">
                                        <p class="">Click a column to remove all lines and transcription data it contains from the project.</p>
                                        <span class="ui-state-error-text"><span class="inline fa fa-alert"></span>This is a destructive process and cannot be undone.</span></p>
                                    </div>
                                    <div class="startHide" id="clearColumnsInst">
                                        <p class="">Click to clear the page, removing all transcription information.</p>
                                        <span class="destroyPage" class="tpenButton ui-state-error" title="Destroy all columns on this page"><span class="pull-left fa fa-circle-o"></span>Destroy All Data</span>
                                        <p class="small"><span class="ui-state-error-text"><span class="inline fa fa-alert"></span>This is a destructive process and cannot be undone.</span><br />
                                         </p>
                                    </div>
                                </div>
                        </div>
                        <div id="ctrlLinesInst" class="actions">
                            <h4 id="ctrlLines" title="Make adjustments at the line level" class="clear-left">Line Controls</h4>
                                <div class="parsingToolButtons">
                                    <span id="addLines" class="tpenButton" title="Split lines to create new ones in a column" show="addLinesInst">Add Lines</span>
                                    <span id="removeLines" class="tpenButton" title="Merge two lines or remove the last line from a column" show="removeLinesInst">Delete/Merge Lines</span>
                                    <span id="adjustLines" class="tpenButton" title="Simple adjustments to individual lines" show="adjustLinesInst">Adjust Lines</span>
                                </div>
                                <div class="activeParsingTool">
                                    <div class="startHide" id="addLinesInst">
                                        <p class="">Click within the shaded area to define the bottom of the new line.</p>
                                        <p class="small"><span class="inline fa fa-check"></span>This method retains all your <acronym title="Text, markup, and notes saved for lines within this column will remain attached.">transcription information</acronym>.<br />
                                        <span><span class="inline fa fa-info"></span>Any <acronym title="text, markup, and notes">transcription information</acronym> will remain with the line above where you click.</span><br />
                                        <span><span class="inline fa fa-info"></span>To add a line outside of the defined columns, <span class="ui-button loud" onclick="$('#ctrlColumns').click();$('#createColumn').click();" title="Click to use the Create a Column option">Create a Column</span>.</span></p>
                                        <div align="center">
                                            <p class="clear-left">Trouble seeing the ruler? Change the color below.</p>
                                            <div id="sampleRuler"></div>
                                            <label for="black"><input onclick="rulerColor('black');" CHECKED type="radio" value="black" name="rulerColor"/>Black</label>
                                            <label for="white"><input onclick='rulerColor("white");' id="white" type="radio" value="white" name="rulerColor"/>White</label>
                                            <label style="margin-left: 10px; margin-right: 3px;" for="customRuler">
                                                Custom
                                                <input style="width:80px;" title="Type the name of any valid HTML color or code. If the code is invalid, a default color will be shown."
                                                type="text" id="customRuler" onkeyup="rulerColor('custom');" placeholder="transparent" value="transparent"/>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="startHide" id="removeLinesInst">
                                        <p class="">Click within the shaded area to merge the highlighted lines or delete the last line of a column.</p>
                                        <p class="small"><span class="inline fa fa-info"></span>This method combines your <acronym title="Text, markup, and notes saved for lines within this column will remain attached.">transcription information</acronym> into the new line.<br />
                                        <span class="ui-state-error-text"><span class="inline fa fa-alert"></span>If a line is removed, so in the information associated <acronym title="text, markup, and notes">with it</acronym>.</span> <br />
                                        <span><span class="inline fa fa-info"></span>To add a line, use the <span class="ui-button loud" onclick="$('#addLines').click();" title="Click to use the Add Lines option">Add Lines</span> option.</span></p>
                                    </div>
                                    <div class="startHide" id="adjustLinesInst">
                                        <p class="">Click and drag the right side of the line to contain the line accurately.</p>
                                        <p class="small"><span class="inline fa fa-check"></span>This method retains all your <acronym title="Text, markup, and notes saved for each line will remain attached.">transcription information</acronym>.<br />
                                        <span><span class="inline fa fa-info"></span>Only the right boundary can be moved in this tool.</span><br />
                                        <span><span class="inline fa fa-info"></span>Make precise, individual changes in the transcription view on the currently selected line.
                                            Hold the ALT key and drag the right side of a line to resize it.  While holding the ALT key
                                        press the left and right arrows to 'bump' the line.</span></p>
                                    </div>
                                </div>
                        </div>
                    </div>
                </div>
                <div id="sidebar">
                    <div id="progress" class="ui-widget-content ui-corner-all">Select an option above</div>
                    <div id="lineResizing" class="ui-widget-content ui-corner-all">Your <span id="originalLine">original</span> pixel line is being resized by <span id="newLine">100</span>%.</div>
                </div>
            </div>

<!--                    Linebreaking Tool-->
           <div id="linebreakSplit" class="ui-widget ui-widget-content split">
               <div class="fullScreenTrans">⇥ Close Tool</div>
               <h3>Linebreak Existing Transcription</h3>
                <div id="linebreakTextContainer">
                    <!-- visible if text is saved -->
           <div>
               This project has text stored for linebreaking:
               <div id="linebreakText">
                   <span id="lbText"> no text stored </span>
                   <!--                   <div id='charLimit' class='ui-corner-all ui-state-error-text small clear'>More characters stored than shown here
                                        If thisProject.getLinebreakCharacterLimit() is available in the project object, this can be more specific
                                      </div>-->
               </div>
               <div id="linebreakOptions">
                   <div id="useText" onclick="Linebreak.useText()" class="tpenButton block" title="Insert this text at the current line">Insert Text Here</div>
                   <a id="newText" class="tpenButton block" title="Upload a new file to linebreak">Upload New File</a>
                   <div id="linebreakStringBtn" class="tpenButton block" title="Attempt linebreaking using this string">Preview Automatic Linebreaks
                       <!--                   TODO replace value with stored value once it is stored-->
                       <input name="linebreakString" id="linebreakString" type="text" placeholder="<lb />" value="" />
                   </div>
                   <div id="useLinebreakText" onclick="Linebreak.useLinebreakText()" class="tpenButton block" style="display:none;" title="Automatically linebreak this page">Use Automatic Linebreaking
                       <span id="linesDetected"></span>
                   </div>
               </div>
                   <ol class="pull-left">
                       <li>Navigate to a line to start;</li>
                       <li><span class="loud">Insert Text</span> as a block; or</li>
                       <li>Enter a linebreak string to attempt automatic linebreaking; and</li>
                       <li>Press Enter to move all text following the cursor down to the next line.</li>
                   </ol>
                   <span class="small">*At the end of the page, the remaining text will be saved for use on the next page.</span>
           </div>
       </div>
       <div id="linebreakNoTextContainer">
<!-- no text saved -->
Begin by <a id="uploadText" class="btn btn-default">uploading some text</a> to linebreak
       </div>



                       </div>
            <div id="compareSplit" class="split">
                <div class="fullScreenTrans">⇥ Close Tool</div>
                <div class="toolLinks">
                    <select id="compareJump" class="lookLikeButtons">
                        <option folioNum="0">Compare To</option>
                    </select>
                    <button class="showMe2" onclick="restoreWorkspace();">Show Workspace</button>
                    <button class="hideMe" style="position: relative;" onclick="hideWorkspaceToSeeImage();" >Hide Workspace</button>
                    <button class="magnifyBtn" magnifyImg="compare" >Inspect <i class="fa fa-search-plus"></i></button>
                </div>

                <img class="compareImage" folioNum="1"></img>
            </div>
<div id='controlsSplit' class='split' style="width:200px;max-width:200px;overflow:auto;">
    <div class="fullScreenTrans"><i class="fa fa-reply"></i> Close Tool </div>
    <div style="padding:15px;">
        <header> Image Controls </header>
        <button which="grayscale" class="block" onclick="toggleFilter('grayscale');" title="Grayscale">
        <i class="fa fa-picture-o" style="color: #999;background: #DDD;border-radius: 2px;"></i>
        Grayscale</button>
        <button which="invert" class="block" onclick="toggleFilter('invert');">
        <i class="fa fa-picture-o" style="background: #FFF;border-radius: 2px;color: #000;"></i>
        Invert</button>
        <div id="imageToolSliders" class="imgTool">
            <i class="fa fa-sun-o"></i> Brightness
            <div id="brightnessSlider"></div>
            <i class="fa fa-adjust"></i> Contrast
            <div id="contrastSlider"></div>
        </div>

        <header> Column Controls</header>
        <button role="button" class="block" onclick="$(this).toggleClass('selected')">
            <label for="lineToggle" title="Toggle Entire Lines">Show Lines</label><input title="Toggle Lines" type="checkbox" id="lineToggle" onchange="toggleLineMarkers();" >
        </button>
        <button role="button" class=" block" onclick="$(this).toggleClass('selected')">
            <label for="indicatorToggle" title="Toggle Lines' Indicator">Show Labels</label><input type="checkbox" id="indicatorToggle" onchange="toggleLineCol();" checked="checked">
        </button>
        <button role="button" id="markerColors" class="block" onclick="markerColors();">Change Line Color</button>
        <button role="button" id="parsingBtn" title="Redraw the lines on this page" class='block'>
            <i class="fa fa-barcode fa-rotate-90"></i>
            Edit Columns</button>

        <header>
            Keyboard Shortcuts
        </header>
        <div>
            <strong>View/Move Image</strong>
            <kbd>CTRL</kbd>+<kbd>ALT</kbd>: hold to temporarily hide the workspace and drag around your page image
        </div>
        <div>
            <strong>Peek-Zoom</strong>
            <kbd>CTRL</kbd>+<kbd>SHIFT</kbd>: peek-zoom into the current line of transcription
        </div>
    </div>
<!--     <button id="moveImage" title="Move Transcription Image" class="block" onclick="startMoveImg();">
        <i class="fa fa-hand-paper-o"></i>
        Move Img</button>
    <p>
        Click to adjust the position of the main image.
    </p> -->


</div>
            <div id="previewSplit" class="split">
                <div class="fullScreenTrans">⇥ Close Tool</div>
                <div class="toolLinks">
                    <button class="showMe2" onclick="restoreWorkspace();">Show Workspace</button>
                    <button class="hideMe" style="position: relative;" onclick="hideWorkspaceToSeeImage();" >Hide Workspace</button>
                </div>
                <div id="previewDiv">

                </div>
            </div>
            <div id="fullPageSplit" class="split">
                <div class="fullScreenTrans">⇥ Close Tool</div>
                <div class="toolLinks">
                    <button class="showMe2" onclick="restoreWorkspace();">Show Workspace</button>
                    <button class="hideMe" style="position: relative;" onclick="hideWorkspaceToSeeImage();" >Hide Workspace</button>
                    <button class="magnifyBtn" style="position: relative;" magnifyImg="full" >Inspect</button>
                </div>
                <div id="fullPageSplitCanvas"><img id="fullPageImg" src="" /></div>
            </div>
        <div id="zoomDiv" class="ui-corner-all"></div>
        <div id="ruler1"></div><div id="ruler2"></div>

        <div id="requestAccessContainer" style="display: none;">
            <div id="requestAccess" class="ui-widget ui-corner-all ui-widget-content">
                <h2 class="ui-widget-header ui-corner-all ui-state-error">Restricted Access</h2>
                <div class="ui-state-error-text" style="text-align: center;"><span style="display: inline-block;" class="ui-icon ui-icon-alert"></span>You do not have permission to view this manuscript!</div>
                <br />
                <form action="requestAccess.jsp" method="POST">
                    <p title="">Request access for from the <span class="manController" title="">TPEN user who controls access</span> to this document.</P
                    <textarea name="reason" placeholder="Add any additional request details."></textarea>
                    <input type="hidden" name="ms" value="">
                    <input type="hidden" name="projectID" value="">
                    <input class="ui-button tpenButton clear right" type="submit" name="submitted" value="Send Request"/>
                </form>
                <a class="returnButton exitPage" href="index.jsp">Return Home</a>
            </div>
        </div>

        <div id="iprAccept" class="ui-widget ui-corner-all ui-widget-content">
            <h2 class="ui-widget-header ui-corner-all">Accept IPR Agreement</h2>
            <p>Please read and accept the IPR agreement below to access <span id="ipr_who" class="loud"></span>. You only need to do this once.</p>
            <div id="iprAgreement" class="notice"></div>
                <span id="ipr_user" class="right small"></span>
                <div class="clear right buttons">
                <button id="accept_ipr" class="ui-button tpenButton" onclick="">I Agree</button>
                <button class="ui-button tpenButton" onclick="document.location='index.jsp'">I do not agree</button>
            </div>
        </div>

        <div id="help">
            <div id="closeHelp" class="ui-icon-closethick ui-icon"></div>
                    <div id="helpPanels">
                        <div class="helpPanel" title="Page Navigation">
                            <h2>Page Navigation</h2>
                            <ul class="helpColumn">
                                <li>Move through the page with the <span class="showMe">Previous Line</span> and <span class="showMe">Next Line</span> buttons to move from line to line.</li>
                                <li>The <span class="showMe">Line Indicator</span> identifies the current column and line as well as the previous column and line based
                                    on the T&#8209;PEN <span ref="glossParsing" class="glossary">image parsing</span>.  Each drawn line also shows its column and line combination.
                                </li>
                                <li>Click on any line to jump to it.  <!--You can do this through the <span class="showMe">View Full Page</span> or <span class="showMe">Preview</span> tools. --></li>
                            </ul>
                        </div>
                        <div class="helpPanel" title="Transcription Tools">
                            <h2>Transcription Tools</h2>
                            <dl class="helpColumn">
                                <dt>Custom Text Entry</dt>
                                <dd>Expand the <span class="showMe">Characters</span> or <span class="showMe">XML Tags</span> list to reveal buttons to insert your custom tags or <span ref="glossSpecialCharacters" class="glossary">special characters</span> into the <span ref="glossTranscriptionArea" class="glossary">transcription area</span>.</dd>
                                <dt class="showMe">View Full Page</dt>
                                <dd>Show the whole image. Click within the full view image to navigate directly to that line in the transcription area. Use the available <span class="showMe">inspection tool</span> to take a closer look.</dd>
<!--
                                <dt class="showMe">History</dt>
                                <dd>Lists the previous saved versions of the <span ref="glossParsing" class="glossary">line parsing</span> and <span ref="glossTranscription" class="glossary">transcription text</span>. Mouseover the history entries to reveal options to revert to a previous version.</dd>
                                <dt class="showMe">Abbreviations</dt>
                                <dd>Browse A. Capelli's <cite>lexicon abbreviarum</cite> Latin and Italian abbreviations.</dd>-->

                                <dt class="showMe">Compare Pages</dt>
                                <dd>View other pages from this project. Use the available <span class="showMe">inspection tool</span> to take a closer look.</dd>
                                <dt class="showMe">Linebreak</dt>
                                <dd>Upload a file for manual or automatic linebreaking.</dd>
                                <dt class="showMe">Correct Parsing</dt>
                                <dd>View and adjust the <span ref="glossParsing" class="glossary">line parsing</span> on this page.</dd>
                                <dt class="showMe">Preview</dt>
                                <dd>Reveal the <span ref="glossTranscription" class="glossary">transcription text</span> on the previous, current, and following pages. Make changes to text on other pages within the tool.</dd>
                            </dl>
                        </div>
                        <div class="helpPanel" title="Manuscript Navigation">
                            <h2>Manuscript Navigation</h2>
                            <ul class="helpColumn">
                                <li>The <span class="showMe">Location Flag</span> shows the shelfmark of the current page.</li>
                                <li>Use the <span class="showMe">Jump to page</span> menu to select any page in the current project.</li>
                                <li>The <span class="showMe">Previous Page</span> and <span class="showMe">Next Page</span> buttons step through the project one page at a time.</li>
                            </ul>
                        </div>
                        <div class="helpPanel" title="Keyboard Shortcuts">
                            <h2>Keyboard Shortcuts</h2>
                            Support for most browsers includes the following simple shortcuts:
                                <dl class="helpColumn">
                                    <dt>CTRL + 1-9:</dt>
                                        <dd>Insert the corresponding special character at the cursor location.</dd>
                                    <dt>CTRL + HOME:</dt>
                                        <dd>Quickly jump to the first line of the current page.</dd>
                                    <dt>TAB:</dt>
                                        <dd>Move forward through lines of transcription. Reverse with SHIFT + TAB.</dd>
                                    <dt>ALT + up/down arrows:</dt>
                                        <dd>Move up and down through lines of transcription with the keyboard arrow keys.</dd>
                                    <dt>ALT + left/right arrows:</dt>
                                        <dd>Bump the active transcription line in the direction the arrow was pushed. *Warning: may create new columns.</dd>
                                    <dt>While holding ALT:</dt>
                                        <dd>Resize the active line by clicking and dragging the left or right edge.</dd>
                                    <dt>ESC:</dt>
                                        <dd>Close any open tool and return to fullscreen transcription.</dd>

<!--                                        <dt>ALT:</dt>
                                        <dd>Hold to adjust the interface. Slide the main workspace up and down to see more of the manuscript;<br/>move the manuscript image freely behind the main workspace; or<br/>resize the bookmark bounding box to precisely bound an odd or skewed line.</dd>-->

<!--                                    <dt>CTRL:</dt>
                                        <dd>Hold to get a better view of the important parts of your manuscript. The bookmark bounding box, location flag, and bug report form will all fade out and let you see the manuscript or tool behind it.</dd>-->

                                    <dt>F1:</dt>
                                        <dd>On the transcription screen, pulls up the application help.</dd>
                                    <dt>F11:</dt>
                                        <dd>Toggle fullscreen, eliminating browser and desktop toolbars.</dd>
<!--                                        <dt>ALT + CTRL:</dt>
                                        <dd>Hold both to use the peek-zoom, which scales the bounded area to fit your screen and increases the quality of the image, if possible.</dd>-->

                                    <dt>+ or - while inspecting:</dt>
                                        <dd>Each keystroke will adjust the magnification of the tool by .4x to fine tune the image result.</dd>
                                </dl>
                        </div>
                        <div class="helpPanel" title="Glossary">
                            <h2>Glossary</h2>
                            Commonly used terms in this application
                            <dl class="helpColumn">
                                    <dt id="glossPage">Page</dt>
                                        <dd>A single image and supporting interface. Some source images may contain partial or multiple folios.</dd>
                                    <dt id="glossProject">Project</dt>
                                        <dd>Collection of images designated for a specific group of users. Defaults to all images within a selected manuscript, but may be altered.</dd>
                                    <dt id="glossManuscript">Manuscript</dt>
                                        <dd>Collection of images on a repository. Often, but not necessarily exemplary of the artifact document.</dd>
                                    <dt id="glossGroup">Group</dt>
                                        <dd>Collection of users associated with a single project. Group membership is controlled by a Group Leader.</dd>
                                    <dt id="glossUser">User</dt>
                                        <dd>Entity intended to represent the human connected to a T&#8209;PEN account. Users login with the e-mail address associated with the T&#8209;PEN account and are displayed to others by a first initial and last name.</dd>
                                    <dt id="glossTranscription">Transcription</dt>
                                        <dd>Usually referring to the textual data associated with an image region. Transcription metadata include specific location, date of creation, and associated image data.</dd>
                                    <dt id="glossTranscriptionArea">Transcription Area</dt>
                                        <dd>Refers to the white textarea region where the user enters transcription text.</dd>
                                    <dt id="glossParsing">Parsing</dt>
                                        <dd>Describes the automatic or manual process of logically splitting a page into rectangular regions to designate individual lines for transcribing. Changes to parsing are saved in the history of a transcription.</dd>
                                    <dt id="glossHistory">History</dt>
                                        <dd>Previous versions of transcriptions. Changes made to textual and parsing data are recorded.</dd>
                                    <dt id="glossSpecialCharacters">Special Characters</dt>
                                        <dd>Custom-coded buttons that automatically enter a unicode character (typically one not included on the user's keyboard) into the transcription area.</dd>
                                    <dt id="glossButtons">Buttons</dt>
                                        <dd>Typically refers to XML Tag objects customized on the Button Management page. May also refer to Special Character objects in the same location. "Buttons" may also used in the generic sense to refer to a graphically distinct, clickable region which invokes an expected action.</dd>
                                </dl>
                        </div>
                    </div>
                    <div id="helpContents">
                        <span class="helpContents helpActive" title="Page Navigation"></span>
                        <span class="helpContents" title="Transcription Tools"></span>
                        <span class="helpContents" title="Manuscript Navigation"></span>
                        <span class="helpContents" title="Keyboard Shortcuts"></span>
                        <span class="helpContents" title="Glossary"></span>
                    </div>
                </div>
                <div id="overlay" class="ui-widget-overlay">
                    <div id="overlayNote">Click the page to return</div>
                </div>
                <div id="location" class="ui-widget-content ui-corner-tr">
                <!--<select class="clear left" onchange="Interaction.navigateTo(this);">
                    <option SELECTED>Jump to page</option>
                </select>-->
                </div>
                <div class="trexHead"></div>
                <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.js"></script>
                <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.js"></script>
                <script type="text/javascript" src="js/transcribe.js"></script>
                <script src="https://use.fontawesome.com/4ae676603d.js"></script>
                <script type="text/javascript">
                    var leftovers = tpen.project.remainingText;
                    // get from StringEscapeUtils.escapeJavaScript(thisProject.getLinebreakText())
                    if(leftovers && leftovers.length){
                        $("#lbText").html(unescape(leftovers));
                        $("#linebreakNoTextContainer").hide();
                    } else {
                        $("#linebreakTextContainer").hide();
                        $("#linebreakNoTextContainer").show();
                    }
                function initLinks(){
                    var uploadLocation = "uploadText.jsp?p="+tpen.project.folios[tpen.screen.currentFolio].folioNumber
                    +"&projectID="+tpen.project.id;
                    $("#uploadText").addClass("exitPage").add("#newText").attr("href",uploadLocation);

                    // add projectID to buttons.jsp links
                    $(".editButtons").addClass("exitPage").attr("href","buttons.jsp?p="
                        + tpen.project.folios[tpen.screen.currentFolio].folioNumber
                        + "&projectID=" + tpen.project.id+"#tabs-1");
                    $(".editXMLs").addClass("exitPage").attr("href","buttons.jsp?p="
                        + tpen.project.folios[tpen.screen.currentFolio].folioNumber
                        + "&projectID=" + tpen.project.id+"#tabs-2");
                }
                </script>

                <script>





    //Page load event triggers and attached here.
    $(document).ready(function(){
        attachWindowResize();
        $("#imgTop, #imgBottom").css("height", "400px");
        $("#imgTop img, #imgBottom img").css("height", "400px");
        $("#imgTop img, #imgBottom img").css("width", "auto");
        $('.transcriptionImage').attr('src', "images/loading2.gif"); //background loader if there is a hang time waiting for image
        //check if logged in
        var user = "";
        var url = "geti";
        $.ajax({
            url: url,
            type: "GET",
            dataType: "json",
            success: function(data){
                //tpen.user.UID = JSON.parse(data);
                if(data.uname && data.uname !== ""){
                    user = data.uname;
                    $("#trimCurrentUser").html(user);
                    $("#trimCurrentUser").attr("title",user);
                    $("#ipr_user").html(user);
                    var theURL = window.location.href;
                    if (theURL.indexOf("projectID=") > -1){
                        var projID = getURLVariable("projectID");
                        if(theURL.indexOf("parsing=true") > -1){
                            loadTranscription(projID, "parsing");
                        }
                        else{
                            loadTranscription(projID, "");
                        }
                    }
                    else {
                        $('#transcriptionTemplate').hide();
                        $('#setTranscriptionObjectArea').show();
                        $(".instructions").show();
                        $(".hideme").show();
                    }

                }
                else {
                    tpen.user.UID = 0;
                    var theURL = window.location.href;
                    return window.location.href = "index.jsp?ref="+encodeURIComponent(theURL);
                }
                //only get iframes after confirmed user authentication
            },
            error: function(jqXHR,error, errorThrown) {
                tpen.user.UID = 0;
                var theURL = window.location.href;
                return window.location.href = "index.jsp?ref="+encodeURIComponent(theURL);
            }
        });


        //get all project metadata so that we can get the project and user tools.
        $(".split").find('iframe').css("height", window.innerHeight+"px");
        $('select').find('option:eq(0)').prop("selected",true); //stops certain bugs caused by previously selected dropdown options.
        $('select').removeAttr("disabled");
        $("#pageJump").on("change",function(){
            var parsing = "";
            if($("#parsingDiv").is(":visible")){
                parsing = "parsing";
            }
            var a = $(this).find("option:selected");
            var b = a.attr("folioNum");
            pageJump(b, parsing);
        });
         $("#compareJump").on("change",function(){
            var a = $(this).find("option:selected");
            var b = a.attr("folioNum");
            compareJump(b);
        });
         $("#splitScreenTools").on("change",function(event){
            var a = $(this).find("option:selected");
            var b = a.attr("splitter");
            splitPage(event,b);
        });

        $('#transcriptionFile').on("change", function(event){;
            var selectedFile = event.target.files[0];
            var reader = new FileReader();
            var result = $('#transcriptionText')
            reader.onload = function(event){
              var fileContent = event.target.result;
              result.html(fileContent);
              $('#transcriptionTemplate').hide();
            };
            reader.readAsText(selectedFile);
        });

        $(".fullScreenTrans").click(function(){
            fullPage();
        });

        $("#closeHelp").click(function(){
            //fullPage();
            $("#help").css({"left":"100%"}).fadeOut(1000);
        });
        $("#helpMe").click(function(){Help.revealHelp;});

        $("#charactersPopin").on("change", function(event){
            var val = $("#charactersPopin").val();
            addchar(val, "");
        });

        $("#xmlTagPopin").on("change", function(event){
            var val = escape($("#xmlTagPopin").val());
            var fullTag = $("#xmlTagPopin option:selected").attr("title");
            var closingTag = "";
            insertAtCursor(val, closingTag, fullTag, false);

        });

        $(".magnifyBtn").click(function(event){
            if ($(this).hasClass("ui-state-active")){
                $('#zoomDiv').hide();
                restoreWorkspace()
                tpen.screen.isMagnifying = false;
                $(document).off("mousemove");
                $(this).removeClass("ui-state-active");
            } else {
                $(this).addClass("ui-state-active");
                tpen.screen.isMagnifying=true;
                magnify($(this).attr("magnifyImg"),event);
            }
        });

//        var lineColor = tpen.screen.colorThisTime.replace(".4", ".9");
        $("#imgTop").hover(
            function(){
                $('.activeLine').css('box-shadow', '0 0 15px 1em rgba(0,0,0,.4)');
            },
            function(){
                $('.activeLine').css('box-shadow', '0 0 15px 0 rgba(0,0,0,1)');
            }
        );

//        $("#imgBottom").hover(
//            function(){
//                $('.activeLine').css('box-shadow', '0px 0px 15px 8px '+lineColor);
//            },
//            function(){
//                var lineColor2 = lineColor.replace(".9", ".4");
//                $('.activeLine').css('box-shadow', '0px 0px 15px 8px '+lineColor2);
//            }
//        );

        document.addEventListener("mousewheel", function(e){
            if(tpen.screen.isMagnifying){
                event.preventDefault();
                var wDelta = e.wheelDelta < 0 ? 'down' : 'up';
                if(wDelta === "up"){
                    tpen.screen.zoomMultiplier += .4;
                    $(document).mousemove();
                }
                else{
                    tpen.screen.zoomMultiplier -= .4;
                    $(document).mousemove();
                }
            }
        });

        $(document).keydown(function(event){
            var ctrlDown = false,
            ctrlKey = 17,
            cmdKey = 91;
            if(tpen.screen.isMagnifying){
                //back out
                if ((event.which === 109) || (event.which === 189) || (event.which === 173) ){ //173  = - in firefox
                    tpen.screen.zoomMultiplier -= .4;
                    $(document).mousemove();
                }
                //ease in
                else if ((event.which === 107) || (event.which === 187) || (event.which === 61)){ // 61 = + in firefox
                    tpen.screen.zoomMultiplier += .4;
                    $(document).mousemove();
                }
                //esc
                else if(event.which === 27){
                    stopMagnify();
                }
                else {

                }
            }
            else if (event.which == 112) { //F1 for help
                event.preventDefault();
                Help.revealHelp();
                //$("#helpMe").click();
            }
            else if (event.which == 18 || event.altKey){
               //console.log('ALT KEY');
            var lineForEditing = $(".activeLine");
               lineForEditing.resizable();
               if(event.altKey&&event.ctrlKey || event.altKey&&event.metaKey){
                   // hide workspace and move image
                   tpen.screen.toggleMoveImage(event);
               }
               //alt + arrows will bump active line left and right
            else if(event.which == 37 && (event.altKey||event.which == 18)){
                   //left
                   event.preventDefault();
                   bumpLine("left", lineForEditing);

               }
               else if (event.which == 39 && (event.altKey||event.which == 18)){
                   //right
                   event.preventDefault();
                   bumpLine("right", lineForEditing);
               }
               else if(event.which === 38){ //up.  Go to prev line
                   previousTranscriptlet();
               }
               else if(event.which === 40){ //down. Go to next line.
                   nextTranscriptlet();
               }
            }
            else if (event.which === 27){
                //Esc during any active tool means stop the tool.  In this case, our only worry is moving the image around.  We may add others later.
                $("#imgTop, #imgBottom").unbind("mousemove");
                $("#imgTop, #imgBottom").unbind("mousedown");
                $("#imgTop, #imgBottom").unbind("mouseup");
                //still need hover event on imgTop
                $("#imgTop").css("cursor", "default");
                $("#imgBottom").css("cursor", "default");
                $(".magnifyBtn").removeClass("selected");
                $("#moveImage").removeClass("selected");
                $(".transcriptlet").children("textarea").removeClass("imageMove").removeAttr("disabled");
                if(tpen.screen.liveTool && tpen.screen.liveTool !== "none" && tpen.screen.liveTool !== "parsing"){
                    fullPage();
                }
            }
            else if (event.which === 13){ //enter
                if (event.shiftKey || event.altKey) return true;
                event.preventDefault();
                Linebreak.moveTextToNextBox();
                return nextTranscriptlet();
            }
            else if (event.which === 9){ // tab
            //TAB hijack to keep behavior as expected
                var inForm = $(document.activeElement).is('input,textarea') && !$(document.activeElement).parent().is('.transcriptlet');
                if(event.which === 9 && !inForm){
                    event.preventDefault();
                    event.stopPropagation();
                    if(event.shiftKey) $("#prevLine").click();
                    else $("#nextLine").click();
                }
            }
            else if (event.ctrlKey || event.metaKey) { //ctrl
                //This is also how you select a new tab in the browser.
                if(event.which >= 49 && event.which <= 57){ //insert a special char
                    event.preventDefault();
                    event.stopPropagation();
                    //find the index in the special chars field and insert it.
                    var hotkey = $("#charactersPopin").children().eq(String.fromCharCode(event.which));
                    hotkey.click(); //populating to the text field fires in onclick to this element, we have to register the change.
                }
                else if(event.ctrlKey && event.which === 36){ //HOME key.  Jump to first line.
                    event.preventDefault();
                    event.stopPropagation();
                    if($("div[pair='A1']").length){
                        $("div[pair='A1']").click();
                    }
                } else if (event.shiftKey && !tpen.screen.isPeeking && !tpen.screen.isMagnifying) {
                    // Peek-Zoom
                    tpen.screen.peekZoom(false);
                }
            }
            else {

            }
            })
            .keyup(function(event){;
                //|| event.altKey is true while it is held down.
                if(event.which == 18){
                    $("#imgTop,#imgBottom").unbind("mousemove").css("cursor", "default");
                    $("#imgTop, #imgBottom").unbind("mousedown");
                    $("#imgTop, #imgBottom").unbind("mouseup");
                    var lineForEditing = $(".transcriptlet[lineserverid='" + $(".activeLine").attr("lineserverid") + "']");
                    updateLine(lineForEditing, false, true); //update the active line in case it was bumped.
                } else if(tpen.screen.isPeeking && (!event.shiftKey || !(event.ctrlKey||event.metaKey))){
                    // cancel Peek-Zoom
                    tpen.screen.peekZoom(true);
                }
            });

            $("#parsingBtn").click(function(){
                if(tpen.screen.isFullscreen)tpen.screen.isUnadjusted = true;
                tpen.screen.isFullscreen = false;
                hideWorkspaceForParsing();
                $("#confirmParsingInst").show();
                $("#parsingBtn").css("box-shadow", "");
            });

           $(".workspaceHandle").mousedown(function(event){moveWorkspace(event);})
            .css("cursor","n-resize");



            $(".parsingToolButtons").children("span").click(function(event){

                var show = $(this).attr("show");
                $("#imgTop").unbind("mousemove");
                $("#imgTop").unbind("mousedown");
                $("#imgTop").unbind("mouseup");
                $("#imgTop").css("cursor", "default");
                $("#imgBottom").css("cursor", "default");
                $(".parsing").removeClass("adjustable");
                $(".parsing").unbind('mousemove');
                $("#ruler1").hide();
                $("#ruler2").hide();

                var thisID = $(this).attr("id");
                $(".parsingToolButtons").find(".tpenButton").removeClass("selected");
                $(this).addClass("selected");
                if (thisID == "createColumn" || thisID == "destroyColumn" || thisID=="clearColumns") {
                    $("#addLines").removeClass("active");
                    $("#removeLines").removeClass("active");
                    $("#ctrlColumnsInst").find(".startHide").hide();
                    $("#"+show).fadeIn(800);
                    $("#ctrlColumnsInst").find(".activeParsingTool").fadeIn(800);
                    $("#ctrlLinesInst").find(".activeParsingTool").fadeOut(800);
                    $(".parsing").unbind();
                    linesToColumns();

                    if (thisID == "createColumn"){
                        $.each($(".parsingColumn"), function(){
                            $(this).removeClass("parsingColumnSelected");
                        });

                        var isCreating = true;
                        adjustColumn(event);
                        ////console.log("New or reparse column");
                        var offset = $('#imgTop').offset();
                        var point = {};
                        var deltaPoint = {x:0,y:0};
                        $("#imgTop").bind({
                                mousedown: function(event){
                                   // //console.log("NEWCOLUMN");
                                    if ((event.target.className.indexOf("transcriptionImage") === -1 )){//|| !$("#createColumn").hasClass("ui-state-active")
                                        isCreating = false;
                                        return true;
                                    }
                                    else{
                                        event.preventDefault();
                                        var newCol = "<div id='newCol' class='parsingColumn ui-resizable' style='z-index:1000; background-color: yellow;'></div>";
                                        point = {x:event.pageX - offset.left,y:event.pageY - offset.top};
                                        $(newCol).insertBefore($("#imgTop img")).css({
                                            'position'  : 'absolute',
                                            'top': point.y,
                                            'left': point.x,
                                            'min-width' : "5px",
                                            'min-height': "5px"
                                        });
                                    }

                                },
                                mousemove:  function(event){
                                    event.preventDefault();
                                    deltaPoint = {
                                        x: event.pageX-point.x,
                                        y: event.pageY-(point.y)
                                    };
                                    if (deltaPoint.x < 0) {
                                      // right to left drawing
                                      $("#newCol").css("left", point.x + deltaPoint.x);
                                    }
                                    if (deltaPoint.y < 0) {
                                      // bottom to top drawing
                                      $("#newCol").css("top", point.y  + deltaPoint.y);
                                    }
                                    $("#newCol").css({
                                      "width": Math.abs(deltaPoint.x),
                                      "height": Math.abs(deltaPoint.y) - 25 //header (.topTrim)
                                    });
                                },
                                mouseup:    function(event){
                                    event.preventDefault();
                                    $("#parsingCover").show();
                                    if (!isCreating){
                                        $("#imgTop").unbind("mousemove");
                                        $("#imgTop").unbind("mousedown");
                                        $("#imgTop").unbind("mouseup");
                                        $("#imgTop").css("cursor", "default");
                                        $("#imgBottom").css("cursor", "default");
                                        return true;
                                    }
                                    var $newCol = $("#newCol");
                                    $newCol.attr({
                                        "lineserverid"   : "-1",
                                        "newline"       : true,
                                        "newcol"        : true,
                                        "linetop"       : parseFloat($newCol.css("top")) / $("#imgTop").height() * 100,
                                        "lineleft"      : parseFloat($newCol.css("left")) / $("#imgTop").width() * 100,
                                        "linewidth"     : $newCol.width() / $("#imgTop").width() * 100,
                                        "lineheight"    : $newCol.height() / $("#imgTop").height() * 100,
                                        "id"            : "",
                                        "hastranscription": false
                                    });
                                    $newCol.css("background-color","transparent");
                                    // Prevent tiny columns on accident
                                    if (parseInt($newCol.attr('linewidth'))+parseInt($newCol.attr('lineheight')) < 12) {
                                        $newCol.remove();
                                        return true;
                                    }
                                    tpen.screen.isAddingLines = true;
                                    var newY = parseFloat($newCol.css("top")) / $("#imgTop").height() * 100;
                                    var newX = parseFloat($newCol.css("left")) / $("#imgTop").width() * 100;
                                    var newH = $newCol.height() / $("#imgTop").height()* 100;
                                    var newW = $newCol.width() / $("#imgTop").width() * 100;

                                    //The column is now a line, so put that into the UI and save it to the DB.
                                    var columnIsLine =$(
                                    "<div class='parsing newColumn' style='\n\
                                        top:"+newY+"%; \n\
                                        left:"+newX+"%; \n\
                                        height:"+newH+"%; \n\
                                        width:"+newW+"%; \n\
                                        z-index : -10;\n\
                                        ' lineserverid=''\n\
                                        linetop='"+newY+"'\n\
                                        lineleft='"+newX+"'\n\
                                        lineheight='"+newH+"'\n\
                                        linewidth='"+newW+"'>\n\
                                    </div>");
                                    if(isCreating){
                                        saveNewLine(null,columnIsLine);
                                        $("#imgTop").append(columnIsLine);
                                    }
                                    adjustColumn(); //Do this so that the new column is adjustable.
                                    $("#createColumn").ajaxStop(function(){
                                        $(this).click()
                                        .unbind("ajaxStop");
                                        isCreating = false;
                                    });
                                    $("#imgTop").unbind("mousemove");
                                    $("#imgTop").unbind("mousedown");
                                    $("#imgTop").unbind("mouseup");
                                    $("#imgTop").css("cursor", "default");
                                    $("#imgBottom").css("cursor", "default");
                                }

                        });
                    }
                    if (thisID === "destroyColumn") {
                      //prep for column adjustment
                      $.each($(".parsingColumn"), function(){
                            $(this).removeClass("parsingColumnSelected");
                        });
                      $(".parsingColumn").bind({
                        mouseenter: function() {
                          $(this).addClass("parsingColumnSelected");
                        },
                        mouseleave: function() {
                          $(this).removeClass("parsingColumnSelected");
                        },
                        click: function() {
                          removeColumn($(this));
                        }
                      });
                    }
                    if (thisID === "clearColumns") {
                            //prep for column adjustment
                            var columnSet = $(".parsingColumn");
                            columnSet.addClass("parsingColumnSelected");
                            var columnText = (columnSet.size() === 1) ? "Destroy This Column" : "Destroy "+columnSet.size()+" Columns";
                            $(".destroyPage").html('<span class="pull-left fa fa-circle"></span>'+columnText+'')
                            .bind('click', function(){destroyPage();})
                    }
                }
                else if (thisID == "addLines" || thisID == "removeLines" || thisID == "adjustLines") {
                    $("#ctrlLinesInst").find(".startHide").hide();
                    $("#"+show).fadeIn(800);
                    $("#ctrlColumnsInst").find(".activeParsingTool").fadeOut(800);
                    $("#ctrlLinesInst").find(".activeParsingTool").fadeIn(800);
                    $("#imgTop").children(".line").addClass("parsing").removeClass("line");
                    $(".parsing").css("z-index", "5");
                    $('.parsing').unbind();
                    $(".parsing").css('cursor','default');
                    $(".parsingColumn").remove();
                    if (thisID == "adjustLines") {
                        $("#addLines").removeClass("active");
                        $("#removeLines").removeClass("active");
                        //prep for adjustment
                        $("#ruler1").hide();
                        $("#ruler2").hide();
                        var thisLineID = -1;
                        var originalW = 1;
                        var thisLine;
                        $(".parsing").addClass("adjustable").removeClass("line");
                        if($(".adjustable").hasClass("ui-resizable")){
                          $(".adjustable").has(".ui-resizable").resizable("enable");
                        }
                        else {
                          $(".adjustable").resizable({
                            handles: "e",
                            containment: 'parent',
                            start: function(event, ui) {
                              originalW = ui.originalSize.width;
                              newW = ui.size.width;
                              $("#progress").html("Resizing Line").fadeIn();
                              $("#lineResizing").show();
                              $("#originalLine").html(originalW);
                              $("#newLine").html(Math.round(100 * (newW / originalW)));
                              $("#sidebar").fadeIn();
                              thisLine = $(".ui-resizable-resizing");
                            },
                            resize: function(event, ui) {
                              newW = ui.size.width;
                              $("#newLine").html(Math.round(100 * (newW / originalW)));
                            },
                            stop: function(event, ui) {
                              $("#progress").html("Line Resized - Saving...");
                              var thisLineID = thisLine.attr("lineserverid");
                              var thisLineW = parseFloat(thisLine.attr("linewidth")) * (newW / originalW);
                              thisLine.attr("linewidth", thisLineW);
                              updateLine(thisLine, false, true);
                              $("#progress").html("Line Saved").delay(3000).fadeOut(1000);
                              $("#lineResizing").delay(3000).fadeOut(1000);
                            }
                          });
                        }
                    }
                    if (thisID == "addLines"){
                        $("#addLines").addClass("active");
                        $("#removeLines").removeClass("active");
                        tpen.screen.isAddingLines = true;
                        $("#imgTop").children(".line").addClass("parsing").removeClass("line");
                        $(".parsing").bind({
                            mouseenter: function(){
                                applyRuler($(this));
                            },
                            mouseleave: function(){
                                removeRuler($(this));
                            },
                            click: function(event){
                                lineChange($(this), event);
                            }
                        });

                    }
                    if (thisID == "removeLines"){
                        $("#removeLines").addClass("active");
                        $("#addLines").removeClass("active");
                        //prep for column adjustment
                        tpen.screen.isAddingLines = false;
                        $(".parsing").bind({
                            mouseenter: function(){
                                applyRuler($(this));
                            },
                            mouseleave: function(){
                                removeRuler($(this));
                            },
                            click: function(event){
                                lineChange($(this), event);
                            }
                        });
                        $("#imgTop").children(".line").addClass("parsing").removeClass("line");
                    }
                };
            });


        $(".accordion").children("span")
        .append("<span class='fa fa-triangle-right pull-left'></span>")
        .click(function(event){
        $("#imgTop").unbind("mousemove");
        $("#imgTop").unbind("mousedown");
        $("#imgTop").unbind("mouseup");
        $("#imgTop").css("cursor", "default");
        $("#imgBottom").css("cursor", "default");
        $(".parsing").unbind('mousemove');
        $("#imgTop").children(".parsing").removeClass("adjustable");
        $(".destroyPage").unbind();
        $(".tpenButton").removeClass("ui-state-active");
        $("#ruler1").hide();
        $("#ruler2").hide();
        var thisID = $(this).attr("id");
        if (!$(this).next("div").is(":visible")) {
            $(this).siblings("div").not($(this).next("div")).slideUp();
            $(this).addClass("ui-state-active")
                .children(".fa-triangle-right").switchClass("fa-triangle-right","fa-triangle-down").end()
                .siblings("span").removeClass("ui-state-active")
                .children(".fa-triangle-down").switchClass("fa-triangle-down","fa-triangle-right");
            $(this).next("div").slideDown();
        }



        if (thisID === "reparseColumns") {
                //load the adjustment tool and then show the reparsing instructions
                $(".parsingColumn").removeClass("parsingColumnSelected");
                var columnSet = $(".parsingColumn");
                $("#reparseColumn").html('<span class="pull-left fa fa-refresh"></span>Submit '+columnSet.size()+' for Reparsing');
                $("#reparseColumn").bind('click', function(){
                    reparseColumns();
                });
            }
        });

         $("#brightnessSlider").slider({
            orientation: "horizontal",
            range: "min",
            max: 200,
            min: 0,
            value: 100,
            slide: imageSlider,
            change: imageSlider
        });
        $("#contrastSlider").slider({
            orientation: "horizontal",
            range: "min",
            max: 200,
            min: 0,
            value: 100,
            slide: imageSlider,
            change: imageSlider
        });

        $("#previewSplit")
        .on("click",".previewText,.previewNotes",function(){edit(this);})
        .on("click","#previewNotes",function(){
            if($(this).hasClass("ui-state-active")){
                $(".previewNotes").hide();
                $("#previewNotes")
                    .text("Show Notes")
                    .removeClass("ui-state-active");
            } else {
                $(".previewNotes").show();
                $("#previewNotes")
                    .text("Hide Notes")
                    .addClass("ui-state-active");
            }
            scrollToCurrentPage();
        });

        $(".helpContents").click(function(){
          Help.select($(this));
        });
      $(".showMe").each(function(index){
          $(this).append(function(){
          var tip = $("<div/>");
          var ref = $(this).attr("ref");
          var content = "<span class='ui-state-default ui-corner-all lightUp' ref='"+index+"'>Show on Screen</span><span class='ui-state-default ui-corner-all video' ref='"+index+"'>Video Help</span>";
          tip.addClass("helpDetail ui-corner-all").html(content);
          return tip;
          });
  }).hover(function(){
          var thisWidth = $(this).width()+10;
          var tipWidth = 200;
          var thisPos = ($(this).position().left > tipWidth/1.8) ? Math.min((tipWidth-thisWidth)/2,(Page.width()-tipWidth-5)) : $(this).position().left - 5;
          var thisHeight = $(this).height();
          //if (thisPos+thisWidth > tipWidth) thisPos = tipWidth-thisWidth;
          $(this).find(".helpDetail").css({
              left  : -thisPos+"px",
              width : tipWidth+"px",
              top   : thisHeight+"px"
          }).show();
      },function(){
          $(".helpDetail").hide();
      });
      $(".lightUp").on("click",function(){
          var refIndex = parseInt($(this).attr("ref"));
          Help.lightUp(refIndex);
      });
      $(".video").on("click",function(){
          var refIndex = parseInt($(this).attr("ref"));
          Help.video(refIndex);
      });
      $(".glossary").append(function(){
          var tip = $("<div/>");
          var ref = $(this).attr("ref");
          var content = $("#"+ref).add($("#"+ref).next("dd")).clone();
          tip.addClass("gloss ui-state-default ui-corner-all").html(content);
          return tip;
      }).hover(function(){
          var thisWidth = $(this).width()+10;
          var thisPos = $(this).position().left-$(this).parent().position().left-5;
          var thisHeight = $(this).height();
          var tipWidth = Math.min($(this).parents(".helpColumn").width()-15,600);
          if (thisPos+thisWidth > tipWidth) thisPos = tipWidth-thisWidth;
          $(this).find(".gloss").css({
              left  : -thisPos+"px",
              width : tipWidth+"px",
              top   : thisHeight+"px"
          }).show();
      },function(){
          $(".gloss").hide();
      }).click(function(){
          var ref = $(this).attr("ref");
          $("#helpContents").children(":last").click();
          var def = $("#"+ref);
          def.css('color','orangered');
      });

        $(".exitPage").click(function(event) {
            var thisLink = $(this).attr("href");
            event.preventDefault();
            //If there is any ajax running and you try to leave a page, this will stop you
            $("body").ajaxStart(function() {
              $(this).addClass("ui-state-disabled");
            }).ajaxStop(function() {
                //When the ajax finishes, you can leave.
              if (thisLink.indexOf("?") != -1)
                thisLink += "&tool=" + tpen.screen.liveTool;
                Data.saveTranscription(thisLink);
            });
            Data.saveTranscription(thisLink);
//            if (leftovers != undefined)
//              Linebreak.saveLeftovers(escape(leftovers));
        });


    });

    /* Allows users to slightly adjust a line within a column while within the transcription interface. */
    function bumpLine(direction, activeLine){
        //values are in pixel, not percentage.
        var id = activeLine.attr("lineserverid");
        if(direction === "left"){
            var currentLineLeft = activeLine.css("left");
            var currentLineLeftPerc = (parseFloat(currentLineLeft) / $("#imgTop").width()) * 100;
            if (currentLineLeftPerc > .3){
                currentLineLeftPerc -= .3;
            }
            else{ //no negative left value
                currentLineLeftPerc = 0.0;
            }
           currentLineLeft = "%"+currentLineLeftPerc;
        }
        else if (direction === "right"){
            var currentLineLeft = activeLine.css("left");
            var currentLineLeftPerc = (parseFloat(currentLineLeft) / $("#imgTop").width()) * 100;
            if (currentLineLeftPerc < 99.7){ //no left values greater than 100
                currentLineLeftPerc += .3;
            }
            else{
                currentLineLeftPerc = 100.0;
            }
           currentLineLeft = "%"+currentLineLeftPerc;
        }
        var currentLineLeftPX = parseFloat(currentLineLeftPerc/100) * $("#imgTop").width() + "px";
        $(".transcriptlet[lineserverid='"+id+"']").attr("lineleft", currentLineLeftPerc);
        activeLine.css("left", currentLineLeftPX);
        //updateLine($(".transcriptlet[lineserverid='"+id+"']"), false, true);
    }


    //UI effects for when a user decides to edit a line within the preview split tool.
    function edit(line){
        var focusLineID = $(line).siblings(".previewLineNumber").attr("lineserverid");
        var transcriptionText = ($(line).hasClass("previewText")) ? ".theText" : ".notes";
        var pair = $(".transcriptlet[lineserverid='"+focusLineID+"']").find(transcriptionText);
        var transcriptlet = $(".transcriptlet[lineserverid='"+focusLineID+"']");
        if ($(line).hasClass("currentPage")){
          if (pair.parent().attr('id') !== tpen.screen.focusItem[1].attr('id')){
              updatePresentation(transcriptlet);
          }
            line.focus();
            $(line).keyup(function(){
                //Data.makeUnsaved();
                pair.val($(this).text());
            });
        }
        else {
            //console.log("NOt the current page.")
        }
    }

    function scrollToCurrentPage(){
        var pageOffset = $(".previewPage").filter(":first").height() + 20;
        $("#previewDiv").animate({
            scrollTop:pageOffset
        },500);
        $("#previewNotes").filter(".ui-state-active").each( // pulled out #previewAnnotations
            function(){
                if ($("."+this.id).is(":hidden")){
                    $("."+this.id).show();
                    scrollToCurrentPage();
                }
            });
    }

    /*
     * Get the inline 'style' attribute of the transcription image containers and attach brightness or contrast filters to it.
     * The entire function is string manipulation and runs quickly.
     */
    function imageSlider(){
        var newFilter = "";
        if(navigator.userAgent.indexOf("Chrome") !== -1 ) { //also works with filter
          newFilter = "-webkit-filter:";
        }
        else if(navigator.userAgent.indexOf("Opera") !== -1 ) {
          newFilter = "-o-filter:";
        }
        else if(navigator.userAgent.indexOf("MSIE") !== -1 ) { //also works with filter
          newFilter= "-ms-filter:";
        }
        else if(navigator.userAgent.indexOf("Firefox") !== -1 ) { //-moz-filter does not work in more recent versions.  The newest version works with regular filter.
          newFilter = "filter:";
        }
        else {
            //Uncomment this code to alert the user that their browser does not support these CSS3 Filter tools.

//          alert("This tool is not supported by your browser.  The supported browsers are:\n\n\
//                Google Chrome\n Microsoft Internet Explorer\nOpera\nLatest version of Firefox");
//          return false;
        }
        var imgTop = document.getElementById("imgTop");
        var imgBtm = document.getElementById("imgBottom");
        var currentStyleTop = imgTop.getAttribute("style");
        var currentStyleBtm = imgBtm.getAttribute("style"); //null if there is no inline style (this happens)
        if (currentStyleTop === "null" || currentStyleTop === null) currentStyleTop = ""; //in case there is no inline style becase that returns null
        if (currentStyleBtm === "null" || currentStyleBtm === null) currentStyleBtm = ""; //in case there is no inline style because that returns null
        var alteredStyleTop = "";
        var alteredStyleBottom = "";
        var pieceToRemoveTop = "";
        var pieceToRemoveBtm = "";
        //Account for the different ways filter can be represented and alter it accordingly
        if(currentStyleTop.indexOf("-webkit-filter") >= 0){ //Chrome
          //Remove current filter string from the style attribute
          pieceToRemoveTop = currentStyleTop.substring(currentStyleTop.indexOf("-webkit-filter"), currentStyleTop.lastIndexOf(";") + 1);
          pieceToRemoveBtm = currentStyleBtm.substring(currentStyleBtm.indexOf("-webkit-filter"), currentStyleBtm.lastIndexOf(";") + 1);

          //Put the pieces of the filter together
          newFilter += " brightness("+$("#brightnessSlider").slider("value")+"%) contrast("+$("#contrastSlider").slider("value")+"%);";
          alteredStyleTop = currentStyleTop.replace(pieceToRemoveTop, "") + newFilter;
          alteredStyleBottom = currentStyleBtm.replace(pieceToRemoveBtm, "") + newFilter;
        }
        else if(currentStyleTop.indexOf("-ms-filter") >= 0){ //microsoft browsers
          pieceToRemoveTop = currentStyleTop.substring(currentStyleTop.indexOf("-ms-filter"), currentStyleTop.lastIndexOf(";") + 1);
          pieceToRemoveBtm = currentStyleBtm.substring(currentStyleBtm.indexOf("-ms-filter"), currentStyleBtm.lastIndexOf(";") + 1);
          //Put the pieces of the filter together
          newFilter += " brightness("+$("#brightnessSlider").slider("value")+"%) contrast("+$("#contrastSlider").slider("value")+"%);";
          alteredStyleTop = currentStyleTop.replace(pieceToRemoveTop, "") + newFilter;
          alteredStyleBottom = currentStyleBtm.replace(pieceToRemoveBtm, "") + newFilter;
        }
        else if(currentStyleTop.indexOf("-o-filter") >= 0){ //Opera
          //Remove current filter string from the style attribute
          pieceToRemoveTop = currentStyleTop.substring(currentStyleTop.indexOf("-o-filter"), currentStyleTop.lastIndexOf(";") + 1);
          pieceToRemoveBtm = currentStyleBtm.substring(currentStyleBtm.indexOf("-o-filter"), currentStyleBtm.lastIndexOf(";") + 1);
          //Put the pieces of the filter together
          newFilter += " brightness("+$("#brightnessSlider").slider("value")+"%) contrast("+$("#contrastSlider").slider("value")+"%);";
          alteredStyleTop = currentStyleTop.replace(pieceToRemoveTop, "") + newFilter;
          alteredStyleBottom = currentStyleBtm.replace(pieceToRemoveBtm, "") + newFilter;
        }
        else if(currentStyleTop.indexOf("filter") >= 0){ //Works with firefox, IE and Chrome, but we specifically set prefixes at the beginning of the function.
          //Remove current filter string from the style attribute
          pieceToRemoveTop = currentStyleTop.substring(currentStyleTop.indexOf("filter"), currentStyleTop.lastIndexOf(";") + 1);
          pieceToRemoveBtm = currentStyleBtm.substring(currentStyleBtm.indexOf("filter"), currentStyleBtm.lastIndexOf(";") + 1);
          //Put the pieces of the filter together
          newFilter += " brightness("+$("#brightnessSlider").slider("value")+"%) contrast("+$("#contrastSlider").slider("value")+"%);";
          alteredStyleTop = currentStyleTop.replace(pieceToRemoveTop, "") + newFilter;
          alteredStyleBottom = currentStyleBtm.replace(pieceToRemoveBtm, "") + newFilter;
        }
        else{ //First time the filter is being added.  The prefix is already a part of newFilter, so we just need to add the rest of the string.
          newFilter += " brightness("+$("#brightnessSlider").slider("value")+"%) contrast("+$("#contrastSlider").slider("value")+"%);";
          alteredStyleTop = currentStyleTop + " "+newFilter;
          alteredStyleBottom = currentStyleBtm +" "+newFilter;
        }
        imgTop.setAttribute("style",alteredStyleTop); //set the style attribute with the appropriate filter string attached to it.
        imgBtm.setAttribute("style",alteredStyleBottom); //set the style attribute with the appropriate filter string attached to it.
    }

    /* Toggle grayscale and invert image CSS filters.v   */
    function toggleFilter(which){
        /*
         * The grayscale/invert toggle classes CANNOT BE DEFINED as the same object being given the brightness/contrast filters or they ALL BREAK
         */
        var filterObjectTop = document.getElementsByClassName("transcriptionImage")[0];
        var filterObjectBottom = document.getElementsByClassName("transcriptionImage")[1];
        var thisFilter = which+"Filter";
        if(filterObjectTop.className.indexOf(thisFilter) >= 0){
          filterObjectTop.className = filterObjectTop.className.replace(thisFilter, '');
          filterObjectBottom.className = filterObjectBottom.className.replace(thisFilter, '');
          $("button[which='"+which+"']").removeClass("selected");
        }
        else{
          filterObjectTop.className = filterObjectTop.className+=" "+thisFilter;
          filterObjectBottom.className = filterObjectBottom.className+=" "+thisFilter;
          $("button[which='"+which+"']").addClass("selected");
        }
    }

    //Make sure the value entered into the area that allows a user to define a custom ruler color is a valida color string.
    function validTextColour(stringToTest) {
        //Alter the following conditions according to your need.
        if (stringToTest === "") { return false; }
        if (stringToTest === "inherit") { return false; }
        if (stringToTest === "transparent") { return true; }

        var image = document.createElement("img");
        image.style.color = "rgb(0, 0, 0)";
        image.style.color = stringToTest;
        if (image.style.color !== "rgb(0, 0, 0)") { return true; }
        image.style.color = "rgb(255, 255, 255)";
        image.style.color = stringToTest;
        return image.style.color !== "rgb(255, 255, 255)";
    }

    //Change the ruler color.
    function rulerColor(color){
        if(color==="custom"){
            color=$("#customRuler").val();
            if(validTextColour(color)){

            }
            else{
                color = "red";
            }

        }
        $("#ruler1").css("color", color).css("background", color);
        $("#ruler2").css("color", color).css("background", color);
        $("#sampleRuler").css("color", color).css("background", color);
    }

    //Turn the ruler on
    function applyRuler(line){
            //var sRCbkp = selectRulerColor; //select Ruler Color backup
            $("#imageTip").html("Add a Line");
            if(!tpen.screen.isAddingLines){
                if (line.attr("lineleft") == line.next("div").attr("lineleft")) {
                    line.next("div").addClass('deletable');
                }
                line.addClass('deletable');
                if($(".deletable").size()>1){
                    $(".deletable").addClass("mergeable");
                    $("#imageTip").html("Merge Line");
                } else {
                    $("#imageTip").html("Delete Line");
                }
               //sRCbkp = 'transparent';
            }
            line.css('cursor','crosshair').bind('mousemove', function(e){
                var myLeft = line.position().left;
                var myWidth = line.width();
                $('#imageTip').show().css({
                    left:e.pageX,
                    top:e.pageY+20
                });
                $('#ruler1').show().css({
                    left: myLeft,
                    top: e.pageY,
                    height:'1px',
                    width:e.pageX-myLeft-7,
                    //background:"red"
                });
                $('#ruler2').show().css({
                    left: e.pageX+7,
                    top: e.pageY,
                    width:myWidth+myLeft-e.pageX-7,
                    height:'1px',
                   // background:"red"
                });
            });

    }
    /**
     * Hides ruler within parsing tool. Called on mouseleave .parsing.
     */
    function removeRuler(line){
        if(!tpen.screen.isAddingLines){$(".deletable").removeClass('deletable mergeable');}
        //line.unbind('mousemove');
        $('#imageTip').hide();
        $('#ruler1').hide();
        $('#ruler2').hide();
    }

    //Triggered when a user alters a line to either create a new one or destroy one.
    function lineChange(e,event){
        $("#parsingCover").show();
        if(tpen.screen.isAddingLines){
            splitLine(e,event);
        }
        else{
            //merge the line you clicked with the line below.  Delete the line below and grow this line by that lines height.
            removeLine(e);
        }

    }

</script>
    </body>
</html>
